<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thunder Recorder Control Panel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1, h2 { color: #0056b3; }
        .section { margin-bottom: 30px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background-color: #f9f9f9; }
        .status-item { margin-bottom: 5px; }
        .status-text { font-weight: bold; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="number"] {
            width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px;
        }
        button {
            padding: 10px 15px; margin-right: 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease;
        }
        button.start { background-color: #28a745; color: white; }
        button.start:hover { background-color: #218838; }
        button.stop { background-color: #dc3545; color: white; }
        button.stop:hover { background-color: #c82333; }
        button.restart { background-color: #007bff; color: white; }
        button.restart:hover { background-color: #0069d9; }
        button.save { background-color: #ffc107; color: #333; }
        button.save:hover { background-color: #e0a800; }
        button.sync { background-color: #333; color: white; }
        button.sync:hover { background-color: #555; }
        textarea {
            width: calc(100% - 20px); height: 300px; padding: 10px; border: 1px solid #ccc; border-radius: 4px;
            background-color: #eee; font-family: 'Courier New', Courier, monospace; overflow-y: scroll; white-space: pre;
        }
        .form-group { margin-bottom: 15px; }
        .disabled-input { background-color: #e9ecef; }
        /* New Table Styles */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #007bff; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        td img { max-width: 100%; height: auto; display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Thunder Recorder Control Panel</h1>

        <div class="section">
            <h2>System Status</h2>
            <p class="status-item">Recorder Status: <span id="recorderStatus" class="status-text">Loading...</span></p>
            <div class="controls">
                <button class="start" onclick="startRecorder()">Start Recorder</button>
                <button class="stop" onclick="stopRecorder()">Stop Recorder</button>
                <button class="sync" onclick="gitSync()">Sync with Git Repo</button>
            </div>
        </div>

        <div class="section">
            <h2>Captured Events</h2>
            <button class="restart" onclick="fetchRecordings()">Refresh List</button>
            <div style="max-height: 500px; overflow-y: auto;">
                <table id="recordingsTable">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Distance (km)</th>
                            <th>Intensity</th>
                            <th>Waveform</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="section">
            <h2>Logs</h2>
            <textarea id="logOutput" readonly></textarea>
        </div>

        <div class="section">
            <h2>Configuration</h2>
            <form id="configForm">
                <!-- Configuration fields from before -->
                <button type="button" class="save" onclick="saveConfig()">Save Configuration</button>
            </form>
        </div>
    </div>

    <script>
        const recorderStatusSpan = document.getElementById('recorderStatus');
        const logOutput = document.getElementById('logOutput');
        const configForm = document.getElementById('configForm');
        const recordingsTableBody = document.querySelector('#recordingsTable tbody');

        // Initial fetch on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Dynamically create config form fields (makes it easier to manage)
            createConfigFields();

            fetchConfig();
            fetchStatus();
            fetchLogs();
            fetchRecordings();
            setInterval(fetchStatus, 5000);
            setInterval(fetchLogs, 7000);
            setInterval(fetchRecordings, 30000); // Refresh recordings list every 30 seconds
        });

        async function fetchData(url, method = 'GET', data = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (data) options.body = JSON.stringify(data);
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Error fetching from ${url}:`, error);
                return null;
            }
        }

        async function fetchStatus() {
            const status = await fetchData('/api/status');
            if (status) {
                recorderStatusSpan.textContent = status.system_state || 'N/A';
                // Add color coding for state
                const color = status.is_running ? 'green' : 'red';
                recorderStatusSpan.style.color = color;
            }
        }

        async function fetchRecordings() {
            const recordings = await fetchData('/api/recordings');
            if (!recordings) return;

            recordingsTableBody.innerHTML = ''; // Clear existing table
            for (const rec of recordings) {
                const row = document.createElement('tr');
                
                const timestamp = new Date(rec.timestamp).toLocaleString();
                const distance = rec.distance_km !== null ? rec.distance_km : 'N/A';
                const intensity = rec.intensity !== null ? rec.intensity : 'N/A';

                row.innerHTML = `
                    <td>${timestamp}</td>
                    <td>${distance}</td>
                    <td>${intensity}</td>
                    <td><img src="${rec.waveform_image_path}" alt="Waveform" /></td>
                `;
                recordingsTableBody.appendChild(row);
            }
        }

        async function fetchLogs() {
            const logs = await fetchData('/api/logs');
            if (logs && logs.logs) {
                logOutput.value = logs.logs.join('');
                logOutput.scrollTop = logOutput.scrollHeight;
            }
        }

        async function startRecorder() {
            const result = await fetchData('/api/start_recorder', 'POST');
            alert(result ? result.message : 'Request failed');
            fetchStatus();
        }

        async function stopRecorder() {
            const result = await fetchData('/api/stop_recorder', 'POST');
            alert(result ? result.message : 'Request failed');
            fetchStatus();
        }

        // --- Config form functions remain the same as before, but we need to create the fields first ---
        function createConfigFields() {
             const fields = [
                { id: "AS3935_I2C_ADDR", label: "AS3935 I2C Address:", type: "number", readonly: true },
                { id: "AS3935_CAPACITANCE", label: "AS3935 Capacitance:", type: "number" },
                { id: "IRQ_PIN", label: "IRQ Pin (GPIO):", type: "number", readonly: true },
                { id: "DEVICE", label: "Audio Input Device (arecord -D):", type: "text" },
                { id: "RECORDING_LENGTH", label: "Recording Length (seconds):", type: "number" },
                { id: "recording_directory", label: "Recording Directory:", type: "text" },
                { id: "waveform_directory", label: "Waveform Directory:", type: "text", readonly: true },
                { id: "noise_floor_lv1", label: "Noise Floor Level (0-7):", type: "number", min: 0, max: 7 },
                { id: "watchdog_threshold", label: "Watchdog Threshold (0-7):", type: "number", min: 0, max: 7 },
                { id: "spike_rejection", label: "Spike Rejection (0-7):", type: "number", min: 0, max: 7 },
                { id: "thunder_recorder_script", label: "Recorder Script Path:", type: "text", readonly: true },
                { id: "log_file", label: "Log File Path:", type: "text", readonly: true },
                { id: "database_file", label: "Database File Path:", type: "text", readonly: true }
            ];

            let formHtml = '';
            fields.forEach(field => {
                formHtml += `
                    <div class="form-group">
                        <label for="${field.id}">${field.label}</label>
                        <input type="${field.type}" id="${field.id}" name="${field.id}" 
                               ${field.readonly ? 'readonly class="disabled-input"' : ''}
                               ${field.min !== undefined ? `min="${field.min}"` : ''}
                               ${field.max !== undefined ? `max="${field.max}"` : ''}>
                    </div>
                `;
            });
            // Find the save button and insert the form HTML before it
            const saveButton = configForm.querySelector('.save');
            saveButton.insertAdjacentHTML('beforebegin', formHtml);
        }

        async function fetchConfig() {
            const config = await fetchData('/api/config');
            if (config) {
                for (const key in config) {
                    if (configForm.elements[key]) {
                        configForm.elements[key].value = config[key];
                    }
                }
            }
        }

        async function saveConfig() {
            const config = {};
            const elements = configForm.elements;
            for (let i = 0; i < elements.length; i++) {
                if (elements[i].name) {
                    if (elements[i].type === 'number') {
                        config[elements[i].name] = parseInt(elements[i].value, 10);
                    } else {
                        config[elements[i].name] = elements[i].value;
                    }
                }
            }
            const result = await fetchData('/api/config', 'POST', config);
            alert(result ? result.message : 'Save request failed');
        }

        async function gitSync() {
            alert('Attempting to sync with Git repository...');
            const result = await fetchData('/api/git_sync', 'POST');
            if (result) {
                alert('Git Sync Output:\n\n' + (result.output || result.message));
                if (result.status === 'success' && (result.output.includes('Updating') || result.output.includes('changed'))) {
                     if(confirm("Update successful. It's recommended to restart the server. For now, you can restart the recorder to use new script code. Restart recorder?")) {
                         stopRecorder().then(startRecorder);
                     }
                }
            } else {
                alert('Failed to get a response from server for Git sync.');
            }
        }

    </script>
</body>
</html>