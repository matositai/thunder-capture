<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thunder Detector Control Panel</title>
    <style>
        :root {
            --dark-bg: #1a1a1a; /* Very dark gray */
            --primary-text: #e0e0e0; /* Light gray */
            --container-bg: #2c2c2c; /* Darker gray */
            --border-color: #444; /* Medium dark gray */
            --header-color: #007bff; /* Blue */
            --highlight-yellow: #ffc107; /* Yellow */
            --success-green: #28a745; /* Green */
            --danger-red: #dc3545; /* Red */
            --button-text: #1a1a1a; /* Very dark gray for button text */
        }

        html, body {
            height: 100%; /* Use 100% for body height for flexbox */
            margin: 0;
            padding: 0; /* Ensure no default margins/padding */
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--dark-bg); 
            color: var(--primary-text);
            display: flex; /* Enable flexbox for vertical layout */
            flex-direction: column; /* Stack children vertically */
        }

        .container { 
            max-width: 1200px; 
            margin: 20px auto; 
            background: var(--container-bg); 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            color: var(--primary-text); /* Changed to primary-text for better visibility within container */
            display: flex; /* Enable flexbox for vertical layout */
            flex-direction: column; /* Stack children vertically */
            flex-grow: 1; /* Allow container to grow and fill space */
        }

        h1, h2 { 
            color: var(--header-color);
            border-bottom: 2px solid var(--header-color);
            padding-bottom: 10px;
        }

        .status-item { margin-bottom: 10px; font-size: 1.1em; }
        .status-text { font-weight: bold; }

        .tab-nav { 
            display: flex; 
            border-bottom: 2px solid var(--border-color); 
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            color: var(--primary-text);
            font-size: 1.1em;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-button.active {
            color: var(--highlight-yellow);
            border-bottom: 3px solid var(--highlight-yellow);
        }
        .tab-button:hover {
            background-color: #383838;
        }

        button {
            padding: 10px 15px; 
            margin-right: 10px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px; 
            transition: background-color 0.3s ease;
            color: var(--button-text);
        }

        button.start { background-color: var(--success-green); }
        button.start:hover { background-color: #218838; }
        button.stop { background-color: var(--danger-red); }
        button.stop:hover { background-color: #c82333; }
        button.refresh { background-color: var(--header-color); color: white; }
        button.refresh:hover { background-color: #0069d9; }
        button.save { background-color: var(--highlight-yellow); }
        button.save:hover { background-color: #e0a800; }
        button.sync { background-color: #555; color: white; }
        button.sync:hover { background-color: #777; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: var(--primary-text); }
        input[type="text"], input[type="number"] {
            width: calc(100% - 22px); 
            padding: 10px; 
            margin-bottom: 10px; 
            border: 1px solid var(--border-color); 
            border-radius: 4px;
            background-color: #333;
            color: var(--primary-text);
        }
        .disabled-input { background-color: #444; }

        /* New Table Styles for Signals */
        #recordingsTable { 
            width: 100%; 
            min-width: 700px; /* Ensure table can overflow horizontally */
            border-collapse: collapse; 
            border-spacing: 0; /* Remove space between cells */
        }
        #recordingsTable tbody tr.metadata-row td {
            border: 1px solid var(--border-color);
            padding: 12px;
            background-color: #333; /* Match input background */
            color: var(--primary-text); /* Match label text color */
        }
        #recordingsTable tbody tr.waveform-row td {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-top: none; /* Remove top border to merge with row above */
        }
        #recordingsTable img {
            width: 100%; /* Make waveform image fill the width */
            max-height: 80px; /* Set a max height for the waveform */
            object-fit: cover; /* Prevent image distortion */
            height: auto;
            display: block;
            border-radius: 4px;
        }
        .table-container {
            /* max-height: will be managed by dynamic height */
            overflow-y: auto; /* Bring back vertical scrolling */
            overflow-x: auto; /* Enable horizontal scrolling */
            flex-grow: 1; /* Allow table container to grow and fill space */
            position: relative; /* Establish stacking context for sticky header */
            /* Re-add scrollbar hiding for Chrome, Safari, Opera */
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .table-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera*/
        }
        /* Remove scrollbar hiding for WebKit, as vertical is hidden by overflow-y: hidden */
        .controls-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .events-header { /* Renamed from events-header for consistency if needed */
            display: flex;
            justify-content: space-between; /* Pushes items to ends */
            align-items: center; /* Vertically centers items */
            margin-bottom: 20px; /* Add some space below */
        }
        .right-aligned {
            margin-left: auto;
        }
        .button-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #recordingsTable thead th {
            position: sticky;
            top: 0;
            background-color: var(--container-bg); /* Match table background or a contrasting color */
            color: var(--primary-text);
            z-index: 100;
            border-bottom: 2px solid var(--border-color);
            font-size: 1.2em; /* Make header text bigger */
            padding: 15px 12px; /* Add more padding */
        }
        .status-label {
            color: var(--primary-text); /* Grey-white color for the label */
        }
        
        /* New class for consistent content panels */
        .content-panel {
            width: 100%;
            flex-grow: 1;
            overflow: auto; /* Handles both x and y scrolling */
            box-sizing: border-box;
            display: flex; /* Make content panel a flex container */
            flex-direction: column; /* Stack children vertically within the panel */
        }

        /* Ensure textareas within panels fill the space correctly */
        .content-panel textarea {
            width: 100%;
            height: 100%; /* Fill available vertical space */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: #222;
            color: var(--primary-text);
            font-family: 'Courier New', Courier, monospace;
            white-space: pre;
            resize: none; /* Disable user resizing */
            flex-grow: 1; /* Allow textarea to grow and fill vertical space */
        }

        /* All sections are hidden by default */
        .section {
            display: none;
            flex-direction: column; /* Default flex for sections to maintain layout */
            flex-grow: 1; /* Allow sections to grow */
        }
        /* Only active section is displayed and set to flex */
        .section.active {
            display: flex;
        }

        /* Specific overrides if needed, but aim for general flex behavior */
        #config .content-panel {
            flex-grow: 0; /* Config form doesn't need to grow vertically */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Thunder Detector Control Panel</h1>

        <div class="section-main">
            <p class="status-item"><span class="status-label">Detector Status:</span> <span id="detectorStatus" class="status-text">Loading...</span></p>
            <div class="controls-row">
                <div>
                    <button class="start" onclick="startDetector()">Start Detector</button>
                    <button class="stop" id="stopDetectorButton" onclick="stopDetector()">Stop Detector</button>
                </div>
                <button class="sync right-aligned" onclick="gitSync()">Sync with Git Repo</button>
            </div>
        </div>

        <div class="tab-nav">
            <button class="tab-button active" onclick="openTab(event, 'events')">Captured Signals</button>
            <button class="tab-button" onclick="openTab(event, 'capture_logs')">Capture Logs</button>
            <button class="tab-button" onclick="openTab(event, 'server_logs')">Server Logs</button>
            <button class="tab-button" onclick="openTab(event, 'config')">Configuration</button>
        </div>

        <div id="events" class="section active">
            <div class="events-header">
                <h2>Captured Signals</h2>
                <button class="refresh" onclick="fetchRecordings()">Refresh List</button>
            </div>
            <div class="table-container content-panel">
                <table id="recordingsTable">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Timestamp</th>
                            <th style="width: 25%;">File</th>
                            <th style="width: 15%;">Duration</th>
                            <th style="width: 20%;">Distance</th>
                            <th style="width: 15%;">Intensity</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div id="capture_logs" class="section">
            <h2>Capture Logs</h2>
            <div class="content-panel">
                <textarea id="captureLogOutput" readonly></textarea>
            </div>
        </div>
        
        <div id="server_logs" class="section">
            <h2>System Logs</h2>
             <div class="content-panel">
                <textarea id="serverLogOutput" readonly></textarea>
            </div>
        </div>

        <div id="config" class="section">
            <h2>Configuration</h2>
            <div class="content-panel">
                <form id="configForm">
                    <!-- Configuration fields will be generated here -->
                    <button type="button" class="save" onclick="saveConfig()">Save Configuration</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const detectorStatusSpan = document.getElementById('detectorStatus');
        const stopDetectorButton = document.getElementById('stopDetectorButton');
        const serverLogOutput = document.getElementById('serverLogOutput');
        const captureLogOutput = document.getElementById('captureLogOutput');
        const configForm = document.getElementById('configForm');
        const recordingsTableBody = document.querySelector('#recordingsTable tbody');

        // Initial fetch on page load
        document.addEventListener('DOMContentLoaded', () => {
            createConfigFields();
            fetchConfig();
            fetchStatus();
            fetchServerLogs();
            fetchCaptureLogs();
            fetchRecordings();
            
            setInterval(fetchStatus, 5000);
            setInterval(fetchServerLogs, 7000);
            setInterval(fetchCaptureLogs, 500); // Poll capture logs more frequently
            setInterval(fetchRecordings, 30000);
        });

        function openTab(evt, tabName) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(s => s.classList.remove('active')); // Hide all sections
            
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(b => b.classList.remove('active')); // Deactivate all buttons
            
            document.getElementById(tabName).classList.add('active'); // Show target section
            evt.currentTarget.classList.add('active'); // Activate target button
        }

        async function fetchData(url, method = 'GET', data = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (data) options.body = JSON.stringify(data);
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`Error fetching from ${url}:`, error);
                return null;
            }
        }

        async function fetchStatus() {
            const status = await fetchData('/api/status');
            if (status) {
                let displayStatus = status.system_state || 'N/A';
                let statusColor = 'var(--border-color)'; // Default to gray/idle

                if (['LISTENING', 'RECORDING', 'PROCESSING'].includes(status.system_state)) {
                    displayStatus = 'Capturing... (' + status.system_state + ')';
                    statusColor = 'var(--highlight-yellow)'; // Yellow for actively capturing
                    stopDetectorButton.disabled = false;
                    stopDetectorButton.classList.remove('button-disabled');
                } else if (status.system_state === "IDLE") {
                    stopDetectorButton.disabled = true;
                    stopDetectorButton.classList.add('button-disabled');
                } else if (status.system_state === "ERROR") {
                    statusColor = 'var(--danger-red)'; // Red for error
                    stopDetectorButton.disabled = false; // Allow stopping even in error
                    stopDetectorButton.classList.remove('button-disabled');
                }

                detectorStatusSpan.textContent = displayStatus;
                detectorStatusSpan.style.color = statusColor;
            }
        }

        async function fetchRecordings() {
            const recordings = await fetchData('/api/recordings');
            if (!recordings) return;

            recordingsTableBody.innerHTML = ''; // Clear existing table
            for (const rec of recordings.slice().reverse()) { // Show newest first
                const metadataRow = document.createElement('tr');
                metadataRow.className = 'metadata-row';
                
                const timestamp = new Date(rec.timestamp).toLocaleString();
                const distance = rec.distance_km !== null ? `${rec.distance_km} km` : 'N/A';
                const intensity = rec.intensity !== null ? rec.intensity : 'N/A';
                const filename = rec.wav_filepath ? rec.wav_filepath.split('/').pop() : 'N/A';
                const duration = rec.duration_seconds !== null ? `${rec.duration_seconds.toFixed(2)}s` : 'N/A';


                metadataRow.innerHTML = `
                    <td style="width: 25%;">${timestamp}</td>
                    <td style="width: 25%;">${filename}</td>
                    <td style="width: 15%;">${duration}</td>
                    <td style="width: 20%;">${distance}</td>
                    <td style="width: 15%;">${intensity}</td>
                `;
                
                const waveformRow = document.createElement('tr');
                waveformRow.className = 'waveform-row';
                // Colspan should match the number of columns in metadataRow
                waveformRow.innerHTML = `<td colspan="5"><img src="${rec.waveform_image_path}?t=${new Date().getTime()}" alt="Waveform" /></td>`;
                
                recordingsTableBody.appendChild(metadataRow);
                recordingsTableBody.appendChild(waveformRow);
            }
        }

        async function fetchServerLogs() {
            const data = await fetchData('/api/server_logs');
            if (data && data.logs) {
                serverLogOutput.value = data.logs.join('');
                serverLogOutput.scrollTop = serverLogOutput.scrollHeight;
            }
        }

        async function fetchCaptureLogs() {
            const data = await fetchData('/api/capture_logs');
            if (data && data.logs) {
                captureLogOutput.value = data.logs.join('');
                captureLogOutput.scrollTop = captureLogOutput.scrollHeight;
            }
        }

        async function startDetector() {
            const result = await fetchData('/api/start_recorder', 'POST'); // Backend still uses start_recorder
            alert(result ? 'Detector start request: ' + result.message : 'Detector start request failed.');
            fetchStatus();
        }

        async function stopDetector() {
            const result = await fetchData('/api/stop_recorder', 'POST'); // Backend still uses stop_recorder
            alert(result ? 'Detector stop request: ' + result.message : 'Detector stop request failed.');
            fetchStatus();
        }
        
        function createConfigFields() {
             const fields = [
                { id: "AS3935_I2C_ADDR", label: "AS3935 I2C Address:", type: "number", readonly: true },
                { id: "AS3935_CAPACITANCE", label: "AS3935 Capacitance:", type: "number" },
                { id: "IRQ_PIN", label: "IRQ Pin (GPIO):", type: "number", readonly: true },
                { id: "DEVICE", label: "Audio Input Device (arecord -D):", type: "text" },
                { id: "RECORDING_LENGTH", label: "Recording Length (seconds):", type: "number" },
                { id: "recording_directory", label: "Recording Directory:", type: "text" },
                { id: "waveform_directory", label: "Waveform Directory:", type: "text", readonly: true },
                { id: "noise_floor_lv1", label: "Noise Floor Level (0-7):", type: "number", min: 0, max: 7 },
                { id: "watchdog_threshold", label: "Watchdog Threshold (0-7):", type: "number", min: 0, max: 7 },
                { id: "spike_rejection", label: "Spike Rejection (0-7):", type: "number", min: 0, max: 7 },
                { id: "thunder_recorder_script", label: "Detector Script Path:", type: "text", readonly: true },
                { id: "log_file", label: "Log File Path:", type: "text", readonly: true },
                { id: "database_file", label: "Database File Path:", type: "text", readonly: true },
                { id: "is_indoor", label: "Indoor Operation:", type: "checkbox" }
            ];

            let formHtml = '';
            fields.forEach(field => {
                if (field.type === "checkbox") {
                    formHtml += `
                        <div class="form-group">
                            <input type="checkbox" id="${field.id}" name="${field.id}">
                            <label for="${field.id}">${field.label}</label>
                        </div>
                    `;
                } else {
                    formHtml += `
                        <div class="form-group">
                            <label for="${field.id}">${field.label}</label>
                            <input type="${field.type}" id="${field.id}" name="${field.id}" 
                                   ${field.readonly ? 'readonly class="disabled-input"' : ''}
                                   ${field.min !== undefined ? `min="${field.min}"` : ''}
                                   ${field.max !== undefined ? `max="${field.max}"` : ''}>
                        </div>
                    `;
                }
            });
            const saveButton = configForm.querySelector('.save');
            saveButton.insertAdjacentHTML('beforebegin', formHtml);
        }

        async function fetchConfig() {
            const config = await fetchData('/api/config');
            if (config) {
                for (const key in config) {
                    const element = configForm.elements[key];
                    if (element) {
                        if (element.type === "checkbox") {
                            element.checked = config[key];
                        } else {
                            element.value = config[key];
                        }
                    }
                }
            }
        }

        async function saveConfig() {
            const config = {};
            const elements = configForm.elements;
            for (let i = 0; i < elements.length; i++) {
                if (elements[i].name) {
                    if (elements[i].type === "checkbox") {
                        config[elements[i].name] = elements[i].checked;
                    } else if (elements[i].type === 'number' && elements[i].value !== '') {
                        config[elements[i].name] = parseInt(elements[i].value, 10);
                    } else if (elements[i].value !== '') {
                        config[elements[i].name] = elements[i].value;
                    }
                }
            }
            const result = await fetchData('/api/config', 'POST', config);
            alert(result ? result.message : 'Save request failed');
        }

        async function gitSync() {
            alert('Attempting to sync with Git repository...');
            const result = await fetchData('/api/git_sync', 'POST');
            if (result) {
                alert('Git Sync Output:\n\n' + (result.output || result.message));
                if (result.status === 'success' && (result.output.includes('Updating') || result.output.includes('changed'))) {
                     if(confirm("Update successful. Restart the server to apply changes. Restart detector now to use new script code?")) {
                         stopDetector().then(startDetector);
                     }
                }
            } else {
                alert('Failed to get a response from server for Git sync.');
            }
        }
    </script>
</body>
</html>